# ==========================================================
# BlackboxTester PR-Agent Dockerfile
# ==========================================================
# Based on official PR-Agent with extensions for SonarQube
# ==========================================================

FROM python:3.11-slim-bookworm

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    curl \
    unzip \
    openjdk-17-jre-headless \
    && rm -rf /var/lib/apt/lists/*

# Install SonarScanner CLI
ENV SONAR_SCANNER_VERSION=5.0.1.3006
RUN curl -L -o /tmp/sonar-scanner.zip \
    https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-${SONAR_SCANNER_VERSION}-linux.zip \
    && unzip /tmp/sonar-scanner.zip -d /opt \
    && mv /opt/sonar-scanner-${SONAR_SCANNER_VERSION}-linux /opt/sonar-scanner \
    && rm /tmp/sonar-scanner.zip \
    && ln -s /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner

# Copy PR-Agent source
COPY pr-agent/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install additional dependencies for our extensions
RUN pip install --no-cache-dir \
    sqlalchemy \
    asyncpg \
    redis \
    stripe \
    httpx

COPY pr-agent/ .

# Create temp directory for repo cloning
RUN mkdir -p /tmp/blackbox

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/ || exit 1

# Start the server
ENV PORT=3000
CMD ["python", "-m", "pr_agent.servers.github_app"]
