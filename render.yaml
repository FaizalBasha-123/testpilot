# TestPilot - Render Blueprint
# Deploy with: render blueprint sync

services:
  # ============================================
  # Gateway (Go) - HTTP Gateway, Auth, Webhooks
  # ============================================
  - type: web
    name: testpilot-gateway
    runtime: go
    repo: https://github.com/YOUR_USERNAME/blackboxtester-mvp
    branch: main
    rootDir: services/gateway
    buildCommand: go build -o gateway .
    startCommand: ./gateway
    plan: starter
    healthCheckPath: /health
    envVars:
      - key: AI_CORE_URL
        sync: false # Gateway-only on Render: set to your tunneled AI Core base URL
      - key: AI_REVIEW_WEBHOOK_URL
        sync: false # Optional explicit webhook URL; defaults to AI_CORE_URL + /api/v1/github_webhooks
      - key: SONAR_SERVICE_URL
        sync: false # Gateway-only on Render: set to your tunneled Sonar Scanner base URL
      - key: ENABLE_MOCK_REVIEW
        value: "false"
      - key: GITHUB_WEBHOOK_SECRET
        sync: false
      - key: GITHUB_TOKEN
        sync: false
      - key: GITHUB_APP_ID
        sync: false
      - key: GITHUB_APP_PRIVATE_KEY
        sync: false
      - key: JWT_SECRET
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: testpilot-db
          property: connectionString
    autoDeploy: true

  # ============================================
  # AI Core (Python) - Review Engine, AI Logic
  # ============================================
  - type: web
    name: testpilot-ai-core
    runtime: docker
    repo: https://github.com/YOUR_USERNAME/blackboxtester-mvp
    branch: main
    rootDir: services/ai-core
    dockerfilePath: docker/Dockerfile
    dockerContext: .
    plan: standard # Needs more memory for LLM calls
    healthCheckPath: /health
    envVars:
      - key: SONAR_SERVICE_URL
        value: http://testpilot-sonar-scanner:8000
      - key: SONARQUBE__URL
        value: http://testpilot-sonarqube:9000
      - key: SONARQUBE__TOKEN
        sync: false
      - key: OPENROUTER__KEY
        sync: false
      - key: GROQ_API_KEY
        sync: false
      - key: GROQ_EMBEDDING_API_KEY
        sync: false
      - key: EMBEDDING_API_BASE
        sync: false
      - key: EMBEDDING_MODEL
        value: text-embedding-3-small
      - key: OPENAI_API_KEY
        sync: false
      - key: CONFIG__MODEL
        value: groq/llama-3.3-70b-versatile
      - key: QDRANT_URL
        value: http://testpilot-qdrant:6333
      - key: DATABASE_URL
        fromDatabase:
          name: testpilot-db
          property: connectionString
      - key: REDIS_URL
        fromService:
          name: testpilot-redis
          type: redis
          property: connectionString
    autoDeploy: true

  # ============================================
  # Sonar Scanner (Rust) - Static Analysis
  # ============================================
  - type: web
    name: testpilot-sonar-scanner
    runtime: docker
    repo: https://github.com/YOUR_USERNAME/blackboxtester-mvp
    branch: main
    rootDir: services/sonar-scanner
    dockerfilePath: Dockerfile
    plan: starter
    healthCheckPath: /health
    envVars:
      - key: SONARQUBE_URL
        value: http://testpilot-sonarqube:9000
      - key: SONARQUBE_TOKEN
        sync: false
      - key: SONARQUBE_PASSWORD
        sync: false
      - key: UPLOAD_LIMIT_MB
        value: "1024"
    autoDeploy: true

  # ============================================
  # SonarQube (Docker) - Rule Engine
  # ============================================
  - type: pserv
    name: testpilot-sonarqube
    runtime: docker
    repo: https://github.com/YOUR_USERNAME/blackboxtester-mvp
    branch: main
    rootDir: services/sonarqube
    dockerfilePath: Dockerfile
    plan: standard
    envVars:
      - key: SONAR_ES_BOOTSTRAP_CHECKS_DISABLE
        value: "true"
      - key: SONAR_ES_JAVA_OPTS
        value: "-Xms512m -Xmx512m"
      - key: SONAR_WEB_JAVA_OPTS
        value: "-Xms512m -Xmx512m"
      - key: SONAR_CE_JAVA_OPTS
        value: "-Xms512m -Xmx512m"
    autoDeploy: true

  # ============================================
  # Qdrant (Docker) - Vector Database
  # ============================================
  - type: pserv
    name: testpilot-qdrant
    runtime: docker
    repo: https://github.com/YOUR_USERNAME/blackboxtester-mvp
    branch: main
    rootDir: services/qdrant
    dockerfilePath: Dockerfile
    plan: starter
    autoDeploy: true

# ============================================
# Databases
# ============================================
databases:
  - name: testpilot-db
    plan: starter
    databaseName: testpilot
    user: testpilot

  # ============================================
  # Redis (Caching & Job Queue)
  # ============================================
  - name: testpilot-redis
    type: redis
    plan: starter
    ipAllowList: [] # Only internal access
